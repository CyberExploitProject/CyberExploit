#!/bin/bash

#==================================================================================
#Ce programme a pour but d'automatiser les tests du projet CyberExploit ===========
#==================================================================================

#Déclaration des variables
message_usage="Usage:  bash  auto.sh  <path to payloads file>  <max nb of brokers>\n"
message_errArgsNbIncorrect="ERROR !\n  -> Illegal number of arguments.\n"

GREEN='\033[0;32m'
NC='\033[0m' # No Color



#S'il n'y a pas le bon nombre d'arguments, on affiche un message d'erreur
if [ "$#" -ne 2 ]; then
	echo -e $message_errArgsNbIncorrect
	echo -e $message_usage

#Sinon on continue notre programme
else
	echo -e "\n\tT H E   C Y B E R E X P L O I T   P R O J E C T\n\n"

	#On crée le fichier de logs
	logFileName=$(date +"%Y-%m-%d_%T").log
	touch ./Logs/$logFileName


	#On récupère le nombre de payloads à tester
  nbPayloads=$(wc -l < $1)


	#On calcule le nombre de tours de boucle à effectuer en fonction du nombre de brokers
  restPayloads=$(($nbPayloads % $2))

	if [ "$restPayloads" -eq 0 ]; then
		nbLoops=$(($nbPayloads / $2))
		restPayloads=$2
	else
		nbLoops=$(($nbPayloads / $2))
		nbLoops=$(($nbLoops + 1))
	fi

	echo -e " *General information:"
	echo -e "    --> Path to the payloads file:                 $(readlink -f $1)"
	echo -e "    --> Number of payloads to test:                $nbPayloads"
	echo -e "    --> Max number of brokers at the same time:    $2"
	echo -e "    --> Number of loops:                           $nbLoops\n"


	#On modifie les informations de configurations du script d'attaque
	echo -n -e " *Editing attack script configuration file ... "
	echo -e "start=False\nactualLoop=1\nnbLoops=$nbLoops\nnbOfBrokers=$2\nlastNbOfBrokersForLastLoop=$restPayloads" > ./Brokers_AttackContainer_Network/AttackContainer_Network/Python/Scripts/script.conf
	echo -e "${GREEN}done${NC}\n"


	#On copie les payloads dans le bon répertoire
	echo -n -e " *Copying payloads into the attack folder ... "
	cat $1 > ./Brokers_AttackContainer_Network/AttackContainer_Network/Python/Scripts/payloads.txt
	echo -e "${GREEN}done${NC}\n"


	#On édite le fichier docker-compose du script d'attaque et du réseau ET on les déploie
	echo -n -e " *Preparing the attack container ... "
	python3 docker-compose-editor.py 192.168.100.0 $2 attack > ./Logs/$logFileName
	echo -e "${GREEN}done${NC}\n"
	echo -e " *Deploying the attack container ... "
	cd ./Brokers_AttackContainer_Network/AttackContainer_Network/
	docker-compose up --build >> ../../Logs/$logFileName
	cd ../../


	#On déploie nos brokers en fonction de ceux dont on a besoin + attack + récupération des logs
	for (( i = 1; i <= $nbLoops; i++ )); do

		echo -e "\n\n *Loop  $i /  $nbLoops"

		#Si on est pas au dernier tour de boucle
		if [[ $i != $nbLoops ]]; then
			#On édite le fichier docker-compose avec le bon nombre de brokers et on les déploie
			echo -n -e "    --> Preparing $2 broker(s) container(s) ... "
			python3 docker-compose-editor.py 192.168.100.0 $2 brokers >> ./Logs/$logFileName
			echo -e "${GREEN}done${NC}"
			echo -e "    --> Deploying $2 broker(s) container(s) ... "
			cd ./Brokers_AttackContainer_Network/Brokers/
			docker-compose up -d --build >> ../../Logs/$logFileName
			cd ../../

			#On lance le script d'attaque
			echo -n -e "    --> Running the attack container ... "
			docker start -a attack >> ./Logs/$logFileName
			bash ./pause.sh >> ./Logs/$logFileName
			echo -e "${GREEN}done${NC}"

			#On récupère les logs
			echo -n -e "    --> Getting the broker(s) logs ... "
			for (( j = 0; j < $2; j++ )); do
				let "payloadIndex = $i - 1"
				let "payloadIndex = $payloadIndex * $2"
				let "payloadIndex = $payloadIndex + $j"
				docker cp broker$j:/fuzzing/mosquitto.log ./Outputs/$payloadIndex.log >> ./Logs/$logFileName
			done
			echo -e "${GREEN}done${NC}"


			#On arrête et supprime les brokers
			echo -n -e "    --> Stopping the broker(s) container(s) ... "
			docker stop $(docker ps -a -q -n $2) >> ./Logs/$logFileName
			echo -e "${GREEN}done${NC}"
			echo -n -e "    --> Removing the broker(s) container(s) ... "
			docker rm $(docker ps -a -q -n $2) >> ./Logs/$logFileName
			echo -e "${GREEN}done${NC}"

		#Sinon si on est au dernier tour
		else

			#On édite le fichier docker-compose avec le bon nombre de brokers et on les déploie
			echo -n -e "    --> Preparing $restPayloads broker(s) container(s) ... "
			python3 docker-compose-editor.py 192.168.100.0 $restPayloads brokers >> ./Logs/$logFileName
			echo -e "${GREEN}done${NC}"
			echo -e "    --> Deploying $restPayloads broker(s) container(s) ... "
			cd ./Brokers_AttackContainer_Network/Brokers/
			docker-compose up -d --build >> ../../Logs/$logFileName
			cd ../../

			#On lance le script d'attaque
			echo -n -e "    --> Running the attack container ... "
			docker start -a attack >> ./Logs/$logFileName
			bash ./pause.sh >> ./Logs/$logFileName
			echo -e "${GREEN}done${NC}"


			#On récupère les logs
			echo -n -e "    --> Getting the broker(s) logs ... "
			let "maxCount = $i * $nbLoops"
			for (( j = 0; j < $restPayloads; j++ )); do
				let "payloadIndex = $i - 1"
				let "payloadIndex = $payloadIndex * $2"
				let "payloadIndex = $payloadIndex + $j"
				docker cp broker$j:/fuzzing/mosquitto.log ./Outputs/$payloadIndex.log >> ./Logs/$logFileName
			done
			echo -e "${GREEN}done${NC}"

			#On arrête et supprime les brokers
			echo -n -e "    --> Stopping the broker(s) container(s) ... "
			docker stop $(docker ps -a -q -n $restPayloads) >> ./Logs/$logFileName
			echo -e "${GREEN}done${NC}"
			echo -n -e "    --> Removing the broker(s) container(s) ... "
			docker rm $(docker ps -a -q -n $restPayloads) >> ./Logs/$logFileName
			echo -e "${GREEN}done${NC}"


			#On supprime le conteneur d'attaque
			echo -n -e "    --> Removing the attack container ... "
			docker rm attack >> ./Logs/$logFileName
			echo -e "${GREEN}done${NC}"
			echo -n -e "    --> Removing the attack image ... "
			docker rmi fuzzing-attack >> ./Logs/$logFileName
			echo -e "${GREEN}done${NC}"
			echo -n -e "    --> Removing the network Fuzznet ... "
			docker network rm fuzznet >> ./Logs/$logFileName
			echo -e "${GREEN}done${NC}\n"

		fi

	done

fi











#
